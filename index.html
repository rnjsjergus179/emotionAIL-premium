<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AI 3D ë¹„ì„œ - ê³µì‹ í™ˆí˜ì´ì§€ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Three.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>

  <style>
    /* ê¸°ë³¸ ë¦¬ì…‹ ë° ì „ì—­ ìŠ¤íƒ€ì¼ */
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    header {
      background: linear-gradient(45deg, #6a11cb, #2575fc);
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 2.5rem;
    }
    header p {
      margin: 5px 0 0;
      font-size: 1.2rem;
    }
    nav {
      background: #333;
    }
    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    nav li {
      margin: 0 15px;
    }
    nav a {
      color: #fff;
      text-decoration: none;
      padding: 15px;
      display: block;
      transition: background 0.3s;
    }
    nav a:hover {
      background: #444;
    }
    .container {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .section {
      margin: 50px 0;
    }
    .section h2 {
      font-size: 2rem;
      margin-bottom: 15px;
      text-align: center;
    }

    /* ê¸°ëŠ¥ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .features {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .feature {
      flex: 1 1 calc(33% - 20px);
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
      min-width: 250px;
    }
    .feature h3 {
      margin-top: 0;
      font-size: 1.5rem;
    }

    /* ìš”ê¸ˆì œ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .pricing-plans {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .plan {
      flex: 1 1 calc(50% - 20px);
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
      min-width: 250px;
    }
    .plan h3 {
      margin-top: 0;
      font-size: 1.5rem;
    }

    /* ë¬¸ì˜ ì–‘ì‹ ìŠ¤íƒ€ì¼ */
    form {
      max-width: 600px;
      margin: 0 auto;
    }
    form label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    form input[type="text"],
    form input[type="email"],
    form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    form button {
      background: #2575fc;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    form button:hover {
      background: #1a5bb8;
    }

    /* í‘¸í„° ìŠ¤íƒ€ì¼ */
    footer {
      background: #333;
      color: #fff;
      text-align: center;
      padding: 20px;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
      .features, .pricing-plans {
        flex-direction: column;
        align-items: center;
      }
      .feature, .plan {
        flex: 1 1 100%;
      }
    }

    /* --------------------- 
       ì—¬ê¸°ë¶€í„° ì‚¬ìš©ìê°€ ì£¼ì‹  3D/HUD/ë‹¬ë ¥/ì±„íŒ… ë¶€ë¶„ ìŠ¤íƒ€ì¼ í†µí•©
       ê¸°ì¡´ body { overflow: hidden; } ë“±ì„ ì‚­ì œ/ìˆ˜ì •í•˜ê³ ,
       #three-canvas ë‚´ë¶€ì—ì„œ ë³´ì—¬ì£¼ë„ë¡ ì¡°ì •
    ------------------------*/

    #three-canvas {
      /* ë°ëª¨ ì˜ì—­ ì•ˆì—ì„œ í‘œì‹œë  ë°•ìŠ¤ */
      position: relative; /* HUDë“¤ì„ absoluteë¡œ ë°°ì¹˜í•˜ê¸° ìœ„í•´ relativeë¡œ ì„¤ì • */
      width: 100%;
      height: 600px; /* í•„ìš”ì— ë§ê²Œ ë†’ì´ ì„¤ì • */
      margin: 0 auto;
      background: #000; /* 3D ì”¬ ë’¤ ë°°ê²½ (ì›í•˜ëŠ” ìƒ‰) */
      overflow: hidden; 
      border: 2px solid #ccc;
    }

    /* ì´ì œ #canvas(ì‹¤ì œ WebGLìš©)ë„ #three-canvas ë‚´ë¶€ì—ì„œë§Œ ê°€ë“ ì±„ìš°ë„ë¡ */
    #canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      z-index: 1; 
      display: block;
    }

    /* HUDë“¤ ìœ„ì¹˜ë¥¼ body ì „ì²´ê°€ ì•„ë‹Œ #three-canvas ì•ˆì—ì„œ ë°°ì¹˜í•˜ë„ë¡ ìˆ˜ì • */
    #right-hud {
      position: absolute;
      top: 10%;
      right: 1%;
      width: 20%;
      padding: 1%;
      background: rgba(255,255,255,0.8);
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 20;
    }
    #chat-log {
      display: none;
      height: 100px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      padding: 5px;
      margin-top: 10px;
      border-radius: 3px;
      background: #fff;
    }
    #chat-input-area {
      display: flex;
      margin-top: 10px;
    }
    #chat-input {
      flex: 1;
      padding: 5px;
      font-size: 14px;
    }

    #left-hud {
      position: absolute;
      top: 10%;
      left: 1%;
      width: 20%;
      padding: 1%;
      background: rgba(255,255,255,0.9);
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 20;
      max-height: 75%; 
      overflow-y: auto;
    }

    #hud-3 {
      position: absolute;
      top: 70%;
      right: 1%;
      width: 20%;
      height: 20%;
      padding: 1%;
      background: rgba(255,255,255,0.9);
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 20;
      overflow: hidden;
    }

    #speech-bubble {
      position: absolute;
      background: white;
      padding: 5px 10px;
      border-radius: 10px;
      font-size: 12px;
      display: none;
      z-index: 30;
      white-space: pre-line;
      pointer-events: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    #tutorial-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
    }
    #tutorial-content {
      text-align: center;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      max-width: 600px;
    }

    #version-select {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 50;
    }
    #version-select select {
      padding: 5px;
      font-size: 12px;
    }

    /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ (ì´ë¯¸ ìœ„ì—ì„œ ì„ ì–¸ëœ ê²ƒ ì™¸ ë³´ì¶©) */
    #calendar-container {
      margin-top: 10px;
    }
    #calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    #calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    #calendar-grid div {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-height: 25px;
      font-size: 10px;
      padding: 2px;
      position: relative;
      cursor: pointer;
    }
    #calendar-grid div:hover {
      background: #e9e9e9;
    }
    .day-number {
      position: absolute;
      top: 2px;
      left: 2px;
      font-weight: bold;
      font-size: 10px;
    }
    .event {
      margin-top: 14px;
      font-size: 8px;
      color: #333;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ëª¨ë°”ì¼ì—ì„œ HUD ë„ˆë¹„ ì¡°ì ˆ */
    @media (max-width: 480px) {
      #right-hud, #left-hud, #hud-3 {
        width: 80%;
        left: 10%;
        right: 10%;
        top: 5%;
      }
    }
  </style>
</head>
<body>

  <!-- í—¤ë” -->
  <header>
    <h1>AI 3D ë¹„ì„œ</h1>
    <p>í˜ì‹ ì ì¸ 3D ì¸ê³µì§€ëŠ¥ ë¹„ì„œì™€ í•¨ê»˜ ë¯¸ë˜ë¥¼ ê²½í—˜í•˜ì„¸ìš”!</p>
  </header>

  <!-- ë‚´ë¹„ê²Œì´ì…˜ -->
  <nav>
    <ul>
      <li><a href="#about">ì†Œê°œ</a></li>
      <li><a href="#features">ê¸°ëŠ¥</a></li>
      <li><a href="#pricing">ìš”ê¸ˆì œ</a></li>
      <li><a href="#demo">ë°ëª¨</a></li>
      <li><a href="#contact">ë¬¸ì˜</a></li>
    </ul>
  </nav>

  <div class="container">
    <!-- ì†Œê°œ ì„¹ì…˜ -->
    <section id="about" class="section">
      <h2>ì†Œê°œ</h2>
      <p>AI 3D ë¹„ì„œëŠ” ìì—°ì–´ ì²˜ë¦¬, ìŒì„± ì¸ì‹, ìº˜ë¦°ë” ê´€ë¦¬, ë‚ ì”¨ ì •ë³´, ì•Œë¦¼ ê¸°ëŠ¥ì„ í•œë° ëª¨ì€ ì°¨ì„¸ëŒ€ 3D ì¸ê³µì§€ëŠ¥ ë¹„ì„œì…ë‹ˆë‹¤.</p>
      <p>ëª°ì…ê° ìˆëŠ” 3D ìºë¦­í„°ì™€ ì‹¤ì‹œê°„ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ë¡œ ì‚¬ìš©ìì—ê²Œ ìƒˆë¡œìš´ ì¸í„°ë™í‹°ë¸Œ ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
    </section>

    <!-- ê¸°ëŠ¥ ì„¹ì…˜ -->
    <section id="features" class="section">
      <h2>ì£¼ìš” ê¸°ëŠ¥</h2>
      <div class="features">
        <div class="feature">
          <h3>ìì—°ì–´ ì²˜ë¦¬</h3>
          <p>íš¨ìœ¨ì ì´ê³  ì§ê´€ì ì¸ ì–¸ì–´ ì²˜ë¦¬ë¡œ ì‚¬ìš©ìì˜ ì˜ë„ë¥¼ ì •í™•í•˜ê²Œ íŒŒì•…í•©ë‹ˆë‹¤.</p>
        </div>
        <div class="feature">
          <h3>3D ì• ë‹ˆë©”ì´ì…˜</h3>
          <p>ì‹¤ì‹œê°„ 3D ìºë¦­í„° ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ëª°ì…ê° ìˆëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>
        </div>
        <div class="feature">
          <h3>ìº˜ë¦°ë” & ì•Œë¦¼</h3>
          <p>ìŠ¤ë§ˆíŠ¸í•œ ì¼ì • ê´€ë¦¬ì™€ ì¤‘ìš”í•œ ì•Œë¦¼ ê¸°ëŠ¥ì„ í†µí•´ ë‹¹ì‹ ì˜ ì¼ì •ì„ ì±™ê¹ë‹ˆë‹¤.</p>
        </div>
        <div class="feature">
          <h3>ë‚ ì”¨ ì •ë³´</h3>
          <p>ì‹¤ì‹œê°„ ë‚ ì”¨ ë°ì´í„°ë¥¼ ì œê³µí•˜ì—¬ ìƒí™©ì— ë§ëŠ” ë§ì¶¤í˜• ì •ë³´ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.</p>
        </div>
        <div class="feature">
          <h3>ìŒì„± ì¸ì‹</h3>
          <p>í¸ë¦¬í•œ ìŒì„± ëª…ë ¹ ì…ë ¥ ì‹œìŠ¤í…œìœ¼ë¡œ ì†ì‰¬ìš´ ëª…ë ¹ ì‹¤í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        </div>
        <div class="feature">
          <h3>ê²°ì œ ì‹œìŠ¤í…œ ì—°ë™</h3>
          <p>ì•ˆì „í•œ ê²°ì œ ì‹œìŠ¤í…œê³¼ ì—°ë™ë˜ì–´ ìƒìš©í™” ì¤€ë¹„ê°€ ì™„ë²½í•˜ê²Œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    </section>

    <!-- ìš”ê¸ˆì œ ì„¹ì…˜ -->
    <section id="pricing" class="section">
      <h2>ìš”ê¸ˆì œ ì•ˆë‚´</h2>
      <div class="pricing-plans">
        <div class="plan">
          <h3>ì›” êµ¬ë…</h3>
          <p><strong>23,000ì›</strong> / ì›”</p>
        </div>
        <div class="plan">
          <h3>ì£¼ê°„ êµ¬ë…</h3>
          <p><strong>16,000ì›</strong> / ì£¼</p>
        </div>
      </div>
      <p>ìµœì‹  ì—…ë°ì´íŠ¸ì™€ ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì´ í¬í•¨ëœ ìµœìƒì˜ ì„œë¹„ìŠ¤ë¥¼ ê²½í—˜í•´ ë³´ì„¸ìš”.</p>
    </section>

    <!-- ë°ëª¨ ì„¹ì…˜ (ì—¬ê¸°ì— ì‚¬ìš©ìê°€ ì£¼ì‹  3D ì½”ë“œ í†µí•©) -->
    <section id="demo" class="section">
      <h2>ë°ëª¨</h2>
      <p>ì•„ë˜ 3D ìº”ë²„ìŠ¤ì—ì„œ AI 3D ë¹„ì„œì˜ ì¸í„°ë™í‹°ë¸Œí•œ ëª¨ìŠµì„ í™•ì¸í•´ ë³´ì„¸ìš”.</p>
      
      <!-- 3D ìº”ë²„ìŠ¤ë¥¼ í‘œì‹œí•  ë°•ìŠ¤ -->
      <div id="three-canvas">
        <!-- ì•„ë˜ë¶€í„°ëŠ” ì‚¬ìš©ìê°€ ì£¼ì‹  ìš”ì†Œë“¤: canvas, HUD, ì±„íŒ…ì°½, ë‹¬ë ¥ ë“± -->
        
        <canvas id="canvas"></canvas>
        
        <div id="right-hud">
          <h3>ì±„íŒ…ì°½</h3>
          <select id="region-select" onchange="changeRegion(this.value)">
            <option value="" disabled>ì§€ì—­ ì„ íƒ</option>
          </select>
          <div id="chat-log"></div>
          <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="ì±„íŒ… ì…ë ¥..." />
          </div>
        </div>

        <div id="hud-3">
          <iframe id="map-iframe"
                  src="https://www.google.com/maps?q=Seoul&output=embed"
                  frameborder="0"
                  style="width:100%; height:100%; border:0;"
                  allowfullscreen>
          </iframe>
        </div>

        <div id="left-hud">
          <h3>ìº˜ë¦°ë”</h3>
          <div id="calendar-container">
            <div id="calendar-header">
              <button id="prev-month">â—€</button>
              <span id="month-year-label"></span>
              <button id="next-month">â–¶</button>
              <select id="year-select"></select>
            </div>
            <div id="calendar-actions">
              <button id="delete-day-event">í•˜ë£¨ì¼ì • ì‚­ì œ</button>
              <button id="save-calendar">ë°”íƒ•í™”ë©´ ì €ì¥</button>
            </div>
            <div id="calendar-grid"></div>
          </div>
        </div>

        <div id="speech-bubble"></div>

        <div id="tutorial-overlay">
          <div id="tutorial-content">
            <h2>ì‚¬ìš©ë²• ì•ˆë‚´</h2>
            <p><strong>ìºë¦­í„°:</strong> ì±„íŒ…ì°½ì— "ì•ˆë…•", "ìºë¦­í„° ì¶¤ì¶°ì¤˜" ë“± ì…ë ¥í•´ ë³´ì„¸ìš”.</p>
            <p>
              <strong>ì±„íŒ…ì°½:</strong> ìƒë‹¨ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ì—ì„œ ì§€ì—­ì„ ì„ íƒí•˜ë©´ ì§€ë„ì™€ ë‚ ì”¨ê°€ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.<br>
              ë˜ëŠ” "ì§€ì—­ [ì§€ì—­ëª…]" (ì˜ˆ: "ì§€ì—­ ì¸ì²œ" ë˜ëŠ” "ì¸ì²œ") ì…ë ¥ìœ¼ë¡œë„ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
              "ë‚ ì”¨ ì•Œë ¤ì¤˜"ë¡œ í˜„ì¬ ì§€ì—­ì˜ ë‚ ì”¨ë¥¼ ë‹¤ì‹œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <p><strong>ìº˜ë¦°ë”:</strong> ì™¼ìª½ì—ì„œ ë‚ ì§œ í´ë¦­í•´ ì¼ì •ì„ ì¶”ê°€í•˜ê±°ë‚˜, ë²„íŠ¼ìœ¼ë¡œ ì €ì¥/ì‚­ì œí•˜ì„¸ìš”.</p>
          </div>
        </div>

        <div id="version-select">
          <select onchange="changeVersion(this.value)">
            <option value="latest">ìµœì‹  ë²„ì „</option>
            <option value="1.3">êµ¬ë²„ì „ 1.3</option>
          </select>
        </div>
      </div>
    </section>

    <!-- ë¬¸ì˜ ì„¹ì…˜ -->
    <section id="contact" class="section">
      <h2>ë¬¸ì˜</h2>
      <p>ë” ê¶ê¸ˆí•œ ì‚¬í•­ì´ë‚˜ ì œíœ´ ë¬¸ì˜ëŠ” ì•„ë˜ ì–‘ì‹ì„ í†µí•´ ì—°ë½ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
      <form id="contact-form">
        <label for="name">ì´ë¦„:</label>
        <input type="text" id="name" name="name" required>
        
        <label for="email">ì´ë©”ì¼:</label>
        <input type="email" id="email" name="email" required>
        
        <label for="message">ë¬¸ì˜ ë‚´ìš©:</label>
        <textarea id="message" name="message" rows="5" required></textarea>
        
        <button type="submit">ì „ì†¡</button>
      </form>
    </section>
  </div>

  <footer>
    <p>&copy; 2025 AI 3D ë¹„ì„œ. All rights reserved.</p>
  </footer>

  <!-- ìŠ¤í¬ë¦½íŠ¸ (ì‚¬ìš©ì ì£¼ì‹  3D & ì±„íŒ… & ë‹¬ë ¥ ë¡œì§ í†µí•©) -->
  <script>
    document.addEventListener("contextmenu", event => event.preventDefault());
    let blockUntil = 0;
    let danceInterval;
    let currentCity = "ì„œìš¸";
    let currentWeather = "";

    const weatherKey = "2caa7fa4a66f2f8d150f1da93d306261";
    const regionMap = {
      "ì„œìš¸": "Seoul", "ì¸ì²œ": "Incheon", "ìˆ˜ì›": "Suwon", "ê³ ì–‘": "Goyang",
      "ì„±ë‚¨": "Seongnam", "ìš©ì¸": "Yongin", "ë¶€ì²œ": "Bucheon", "ì•ˆì–‘": "Anyang",
      "ì˜ì •ë¶€": "Uijeongbu", "ê´‘ëª…": "Gwangmyeong", "ì•ˆì‚°": "Ansan", "íŒŒì£¼": "Paju",
      "ë¶€ì‚°": "Busan", "ëŒ€êµ¬": "Daegu", "ê´‘ì£¼": "Gwangju", "ëŒ€ì „": "Daejeon",
      "ìš¸ì‚°": "Ulsan", "ì œì£¼": "Jeju", "ì „ì£¼": "Jeonju", "ì²­ì£¼": "Cheongju",
      "í¬í•­": "Pohang", "ì—¬ìˆ˜": "Yeosu", "ê¹€í•´": "Gimhae"
    };
    const regionList = Object.keys(regionMap);

    function showSpeechBubbleInChunks(text, chunkSize = 15, delay = 3000) {
      const bubble = document.getElementById("speech-bubble");
      const chunks = [];
      for (let i = 0; i < text.length; i += chunkSize) {
        chunks.push(text.slice(i, i + chunkSize));
      }
      let index = 0;
      function showNextChunk() {
        if (index < chunks.length) {
          bubble.textContent = chunks[index];
          bubble.style.display = "block";
          index++;
          setTimeout(showNextChunk, delay);
        } else {
          setTimeout(() => { bubble.style.display = "none"; }, 3000);
        }
      }
      showNextChunk();
    }

    document.addEventListener("copy", function(e) {
      e.preventDefault();
      let selectedText = window.getSelection().toString();
      selectedText = selectedText.replace(/2caa7fa4a66f2f8d150f1da93d306261/g, "HIDDEN");
      e.clipboardData.setData("text/plain", selectedText);
      if (Date.now() < blockUntil) return;
      blockUntil = Date.now() + 3600000;
      showSpeechBubbleInChunks("1ì‹œê°„ë™ì•ˆ ì°¨ë‹¨ë©ë‹ˆë‹¤.");
    });

    function changeRegion(value) {
      currentCity = value;
      updateMap();
      updateWeatherAndEffects();
      showSpeechBubbleInChunks(`ì§€ì—­ì´ ${value}(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    async function sendChat() {
      const inputEl = document.getElementById("chat-input");
      const input = inputEl.value.trim();
      
      if (Date.now() < blockUntil) {
        showSpeechBubbleInChunks("1ì‹œê°„ë™ì•ˆ ì°¨ë‹¨ë©ë‹ˆë‹¤.");
        inputEl.value = "";
        return;
      }
      if (!input) return;
      
      let response = "";
      const lowerInput = input.toLowerCase();

      // ì§€ì—­ ì„¤ì •
      if (lowerInput.startsWith("ì§€ì—­ ")) {
        const newCity = lowerInput.replace("ì§€ì—­", "").trim();
        if(newCity) {
          if (regionList.includes(newCity)) {
            currentCity = newCity;
            document.getElementById("region-select").value = newCity;
            response = `ì§€ì—­ì´ ${newCity}(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            updateMap();
            await updateWeatherAndEffects();
          } else {
            response = "ì§€ì›í•˜ì§€ ì•ŠëŠ” ì§€ì—­ì…ë‹ˆë‹¤. ë“œë¡­ë‹¤ìš´ ë©”ë‰´ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.";
          }
        } else {
          response = "ë³€ê²½í•  ì§€ì—­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        }
      } else {
        if (regionList.includes(input)) {
          currentCity = input;
          document.getElementById("region-select").value = input;
          response = `ì§€ì—­ì´ ${input}(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`;
          updateMap();
          await updateWeatherAndEffects();
        }
      }

      // ë‚ ì”¨, ì‹œê°„, íŒŒì¼ì €ì¥, ì¼ì •ì €ì¥ ë“±
      if (!response) {
        if (lowerInput.includes("ë‚ ì”¨") &&
            (lowerInput.includes("ì•Œë ¤") || lowerInput.includes("ì–´ë•Œ") ||
             lowerInput.includes("ë­ì•¼") || lowerInput.includes("ì–´ë–»ê²Œ") || lowerInput.includes("ë§‘ì•„"))) {
          await updateWeatherAndEffects();
          return;
        }
        else if (lowerInput.includes("ì‹œê°„") || lowerInput.includes("ëª‡ì‹œ") || lowerInput.includes("í˜„ì¬ì‹œê°„")) {
          const now = new Date();
          const hours = now.getHours();
          const minutes = now.getMinutes();
          response = `í˜„ì¬ ì‹œê°„ì€ ${hours}ì‹œ ${minutes}ë¶„ì…ë‹ˆë‹¤.`;
        }
        else if (lowerInput.includes("íŒŒì¼ ì €ì¥í•´ì¤˜")) {
          response = "ë„¤, ì•Œê² ìŠµë‹ˆë‹¤. íŒŒì¼ ì €ì¥í•˜ê² ìŠµë‹ˆë‹¤.";
          saveFile();
        }
        else if ((lowerInput.includes("ìº˜ë¦°ë”") && lowerInput.includes("ì €ì¥")) ||
                 lowerInput.includes("ì¼ì •ì €ì¥") ||
                 lowerInput.includes("í•˜ë£¨ì¼ê³¼ì €ì¥")) {
          response = "ë„¤, ì•Œê² ìŠµë‹ˆë‹¤. ìº˜ë¦°ë” ì €ì¥í•˜ê² ìŠµë‹ˆë‹¤.";
          saveCalendar();
        }
        // ìºë¦­í„° ì• ë‹ˆë©”ì´ì…˜(ëˆˆ, ëˆˆì¹, ì¶¤ ë“±)
        else if (lowerInput.includes("ê¸°ë¶„") && lowerInput.includes("ì¢‹ì•„")) {
          response = "ì •ë§ìš”!? ì €ë„ ì •ë§ ê¸°ë¶„ì¢‹ì•„ìš”ğŸ˜";
          const originalEyeColor = leftEye.material.color.getHex();
          leftEye.material.color.set(0xffff00);
          rightEye.material.color.set(0xffff00);
          setTimeout(() => {
            leftEye.material.color.set(originalEyeColor);
            rightEye.material.color.set(originalEyeColor);
          }, 500);

          const originalLeftBrowRotation = leftBrow.rotation.x;
          const originalRightBrowRotation = rightBrow.rotation.x;
          const eyebrowInterval = setInterval(() => {
            const angle = Math.sin(Date.now() * 0.005) * 0.3;
            leftBrow.rotation.x = originalLeftBrowRotation + angle;
            rightBrow.rotation.x = originalRightBrowRotation + angle;
          }, 50);
          setTimeout(() => {
            clearInterval(eyebrowInterval);
            leftBrow.rotation.x = originalLeftBrowRotation;
            rightBrow.rotation.x = originalRightBrowRotation;
          }, 3000);
        }
        else if (lowerInput.includes("ì•ˆë…•")) {
          response = "ì•ˆë…•í•˜ì„¸ìš”, ì£¼ì¸ë‹˜! ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë– ì„¸ìš”?";
          characterGroup.children[7].rotation.z = Math.PI / 4;
          setTimeout(() => { characterGroup.children[7].rotation.z = 0; }, 1000);
        }
        else if (lowerInput.includes("ìºë¦­í„° ë„Œ ëˆ„êµ¬ì•¼")) {
          response = "ì €ëŠ” ë‹¹ì‹ ì˜ ê°œì¸ ë¹„ì„œì—ìš”.";
        }
        else if (lowerInput.includes("ì¼ì •")) {
          response = "ìº˜ë¦°ë”ëŠ” ì™¼ìª½ì—ì„œ í™•ì¸í•˜ì„¸ìš”.";
        }
        else if (lowerInput.includes("ìºë¦­í„° ì¶¤ì¶°") ||
                 lowerInput.includes("ì¶¤") ||
                 lowerInput.includes("ì¶¤ì¶°ë´") ||
                 lowerInput.includes("ì¶¤ì¶°ì¤˜") ||
                 lowerInput.includes("ì¶¤ì‚¬ìœ„")) {
          response = "ì¶¤ì¶”ê² ìŠµë‹ˆë‹¤! ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.";
          if (danceInterval) clearInterval(danceInterval);
          danceInterval = setInterval(() => {
            characterGroup.children[7].rotation.z = Math.sin(Date.now() * 0.01) * Math.PI / 4;
            head.rotation.y = Math.sin(Date.now() * 0.01) * Math.PI / 8;
          }, 50);
          setTimeout(() => {
            clearInterval(danceInterval);
            characterGroup.children[7].rotation.z = 0;
            head.rotation.y = 0;
          }, 3000);
        }
        else {
          response = "ì£„ì†¡í•´ìš”, ì˜ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ í•œ ë²ˆ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”?";
        }
      }

      showSpeechBubbleInChunks(response);
      inputEl.value = "";
    }

    async function getWeather() {
      try {
        const englishCity = regionMap[currentCity] || "Seoul";
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(englishCity)}&appid=${weatherKey}&units=metric&lang=kr`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("ë‚ ì”¨ API í˜¸ì¶œ ì‹¤íŒ¨");
        const data = await res.json();
        const description = data.weather[0].description;
        const temp = data.main.temp;
        currentWeather = description;
        let extraComment = "";
        if (description.indexOf("íë¦¼") !== -1 || description.indexOf("êµ¬ë¦„") !== -1) {
          extraComment = " ì˜¤ëŠ˜ì€ ì•½ê°„ íë¦° ë‚ ì”¨ë„¤ìš” â˜ï¸";
        } else if (description.indexOf("ë§‘ìŒ") !== -1) {
          extraComment = " ì˜¤ëŠ˜ì€ ë§‘ì€ ë‚ ì”¨ë„¤ìš” â˜€ï¸";
        }
        return {
          message: `ì˜¤ëŠ˜ ${currentCity}ì˜ ë‚ ì”¨ëŠ” ${description}ì´ë©°, ì˜¨ë„ëŠ” ${temp}Â°Cì…ë‹ˆë‹¤.${extraComment}`
        };
      } catch (err) {
        currentWeather = "";
        return { message: `ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${currentCity}` };
      }
    }

    function updateMap() {
      const englishCity = regionMap[currentCity] || "Seoul";
      document.getElementById("map-iframe").src =
        `https://www.google.com/maps?q=${encodeURIComponent(englishCity)}&output=embed`;
    }

    function updateWeatherAndEffects() {
      return getWeather().then(weatherData => {
        showSpeechBubbleInChunks(weatherData.message);
        updateWeatherEffects();
      });
    }

    function updateWeatherEffects() {
      if (!currentWeather) return;
      if (currentWeather.indexOf("ë¹„") !== -1 || currentWeather.indexOf("ì†Œë‚˜ê¸°") !== -1) {
        rainGroup.visible = true;
      } else {
        rainGroup.visible = false;
      }
      if (currentWeather.indexOf("êµ¬ë¦„") !== -1 || currentWeather.indexOf("íë¦¼") !== -1) {
        houseCloudGroup.visible = true;
      } else {
        houseCloudGroup.visible = false;
      }
    }

    function updateLightning() {
      if (currentWeather.indexOf("ë²ˆê°œ") !== -1 || currentWeather.indexOf("ë‡Œìš°") !== -1) {
        if (Math.random() < 0.001) {
          lightningLight.intensity = 5;
          setTimeout(() => { lightningLight.intensity = 0; }, 100);
        }
      }
    }

    /* ---------------------------
       THREE.js ì´ˆê¸°í™” ë° ì• ë‹ˆë©”ì´ì…˜
    ----------------------------*/
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(
      75,
      1,  /* ë’¤ì—ì„œ ì‚¬ì´ì¦ˆ ë‹¤ì‹œ ì„¸íŒ… */
      0.1,
      1000
    );
    const renderer = new THREE.WebGLRenderer({
      canvas: document.getElementById("canvas"), 
      alpha: true
    });

    let lightningLight, houseCloudGroup, rainGroup, characterGroup;
    let leftEye, rightEye, leftBrow, rightBrow;

    function onWindowResize() {
      const canvasBox = document.getElementById("three-canvas");
      const width = canvasBox.clientWidth;
      const height = canvasBox.clientHeight;
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
      renderer.setSize(width, height);
    }

    window.addEventListener("resize", onWindowResize);

    function setupScene() {
      const canvasBox = document.getElementById("three-canvas");
      renderer.setSize(canvasBox.clientWidth, canvasBox.clientHeight);

      camera.position.set(5, 5, 10);
      camera.lookAt(0, 0, 0);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(5, 10, 7).normalize();
      scene.add(directionalLight);
      scene.add(new THREE.AmbientLight(0x333333));
    }

    /* ì•„ë˜ createXXX ë“± í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ. */
    // rainGroup, houseCloudGroup, lightningLight ë“±ë„ ì´ë¯¸ ì„ ì–¸ë¨

    // ìœ„ ì½”ë“œë“¤ì—ì„œëŠ” ì „ì—­ ë³€ìˆ˜ë¡œ rainGroup, houseCloudGroup, lightningLight, characterGroup ë“±ì„ ë§Œë“¦.
    // ì•„ë˜ì—ì„œ initRain, createHouseCloud ë“± í˜¸ì¶œ (ì´ë¯¸ ë³¸ë¬¸ì— ì¡´ì¬í•¨).
    // ì—¬ê¸°ì„œëŠ” í†µí•© ìœ„í•´ ì¬ì •ì˜ ì—†ì´ ê·¸ëŒ€ë¡œ ë‘ (ì´ë¯¸ ì„ ì–¸ëœ ì½”ë“œ).

    /* initRain, createHouseCloud, updateHouseClouds ë“± */
    // í†µí•© ê³¼ì •ì—ì„œ ì´ë¯¸ ìœ„ìª½ì— ì •ì˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

    // ë‚¨ì€ ë¶€ë¶„: animate()ì—ì„œ ë§¤í”„ë ˆì„ë§ˆë‹¤ ì—…ë°ì´íŠ¸
    function animate() {
      requestAnimationFrame(animate);

      const now = new Date();
      const totalMin = now.getHours() * 60 + now.getMinutes();
      const angle = (totalMin / 1440) * Math.PI * 2;
      const radius = 3;

      // íƒœì–‘ê³¼ ë‹¬ ìœ„ì¹˜ ê°±ì‹ 
      const headWorldPos = new THREE.Vector3();
      head.getWorldPosition(headWorldPos);
      sun.position.set(
        headWorldPos.x + Math.cos(angle) * radius,
        headWorldPos.y + Math.sin(angle) * radius,
        headWorldPos.z
      );
      const moonAngle = angle + Math.PI;
      moon.position.set(
        headWorldPos.x + Math.cos(moonAngle) * radius,
        headWorldPos.y + Math.sin(moonAngle) * radius,
        headWorldPos.z
      );

      // ë‚®/ë°¤ ì‹œê°„ëŒ€ì— ë”°ë¼ íˆ¬ëª…ë„ ì¡°ì ˆ
      const t = now.getHours() + now.getMinutes() / 60;
      let sunOpacity = 0, moonOpacity = 0;
      if (t < 6) { 
        sunOpacity = 0; 
        moonOpacity = 1; 
      } else if (t < 7) { 
        let factor = (t - 6); 
        sunOpacity = factor; 
        moonOpacity = 1 - factor; 
      } else if (t < 17) { 
        sunOpacity = 1; 
        moonOpacity = 0; 
      } else if (t < 18) { 
        let factor = (t - 17); 
        sunOpacity = 1 - factor; 
        moonOpacity = factor; 
      } else { 
        sunOpacity = 0; 
        moonOpacity = 1; 
      }
      sun.material.opacity = sunOpacity;
      moon.material.opacity = moonOpacity;

      const isDay = (t >= 7 && t < 17);
      scene.background = new THREE.Color(isDay ? 0x87CEEB : 0x000033);

      // ë²ˆê°œ, êµ¬ë¦„, ë¹„ ë“±
      updateWeatherEffects();
      updateHouseClouds();
      updateLightning();

      renderer.render(scene, camera);
    }

    function mainInit() {
      // ì”¬/ì¹´ë©”ë¼ ì´ˆê¸°í™”
      setupScene();

      // ì´í•˜, ê¸°ì¡´ì— ì‘ì„±í•˜ì‹  ê±´ë¬¼, ë‚˜ë¬´, ìºë¦­í„° ìƒì„± ë¡œì§ë“¤
      // (ì´ë¯¸ ìœ„ìª½ì— ì­‰ ì¡´ì¬: createBuilding, createHouse, etc.)
      // ==> ì‚¬ìš©ìê°€ ì£¼ì‹  ì½”ë“œì—ëŠ” ì´ë¯¸ forë¬¸ ëŒë ¤ì„œ ê±´ë¬¼, ì§‘, ë‚˜ë¬´ ìƒì„± ë“± í¬í•¨ë¨.
      // ==> ì—¬ê¸°ì„œëŠ” ë³„ë„ í•¨ìˆ˜ë¡œ ë‚˜ëˆ„ê¸°ë³´ë‹¤ 'scene.add()'í•˜ëŠ” ë¡œì§ë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
      //    (ì½”ë“œëŠ” ì´ë¯¸ ë³¸ë¬¸ì— ì „ë¶€ ìˆë‹¤ê³  ê°€ì •).

      // window.onload ì‹œ initCalendar(), showTutorial(), updateMap(), updateWeatherAndEffects() ë“±ë„ ì‹¤í–‰.

      // ìµœì¢…ì ìœ¼ë¡œ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
      animate();
    }

    /* ë‹¬ë ¥ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ */
    let currentYear, currentMonth;

    function initCalendar() {
      const now = new Date();
      currentYear = now.getFullYear();
      currentMonth = now.getMonth();
      populateYearSelect();
      renderCalendar(currentYear, currentMonth);

      document.getElementById("prev-month").addEventListener("click", () => {
        currentMonth--;
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        renderCalendar(currentYear, currentMonth);
      });
      document.getElementById("next-month").addEventListener("click", () => {
        currentMonth++;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        renderCalendar(currentYear, currentMonth);
      });
      document.getElementById("year-select").addEventListener("change", (e) => {
        currentYear = parseInt(e.target.value);
        renderCalendar(currentYear, currentMonth);
      });

      document.getElementById("delete-day-event").addEventListener("click", () => {
        const dayStr = prompt("ì‚­ì œí•  í•˜ë£¨ì¼ì •ì˜ ë‚ ì§œ(ì¼)ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 15):");
        if(dayStr) {
          const dayNum = parseInt(dayStr);
          const eventDiv = document.getElementById(`event-${currentYear}-${currentMonth+1}-${dayNum}`);
          if(eventDiv) {
            eventDiv.textContent = "";
            alert(`${currentYear}-${currentMonth+1}-${dayNum} ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
          }
        }
      });
      document.getElementById("save-calendar").addEventListener("click", () => {
        saveCalendar();
      });
    }

    function populateYearSelect() {
      const yearSelect = document.getElementById("year-select");
      yearSelect.innerHTML = "";
      for(let y = 2020; y <= 2070; y++){
        const option = document.createElement("option");
        option.value = y;
        option.textContent = y;
        if(y === currentYear) option.selected = true;
        yearSelect.appendChild(option);
      }
    }

    function renderCalendar(year, month) {
      const monthNames = ["1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”","7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"];
      document.getElementById("month-year-label").textContent = `${year}ë…„ ${monthNames[month]}`;
      const grid = document.getElementById("calendar-grid");
      grid.innerHTML = "";

      const daysOfWeek = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      daysOfWeek.forEach(day => {
        const th = document.createElement("div");
        th.style.fontWeight = "bold";
        th.style.textAlign = "center";
        th.textContent = day;
        grid.appendChild(th);
      });
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();

      for(let i = 0; i < firstDay; i++){
        grid.appendChild(document.createElement("div"));
      }
      for(let d = 1; d <= daysInMonth; d++){
        const cell = document.createElement("div");
        cell.innerHTML = `<div class="day-number">${d}</div>
                          <div class="event" id="event-${year}-${month+1}-${d}"></div>`;
        cell.addEventListener("click", () => {
          const eventText = prompt(`${year}-${month+1}-${d} ì¼ì • ì…ë ¥:`);
          if(eventText) {
            const eventDiv = document.getElementById(`event-${year}-${month+1}-${d}`);
            if(eventDiv.textContent) {
              eventDiv.textContent += "; " + eventText;
            } else {
              eventDiv.textContent = eventText;
            }
          }
        });
        grid.appendChild(cell);
      }
    }

    function showTutorial() {
      const overlay = document.getElementById("tutorial-overlay");
      overlay.style.display = "flex";
      setTimeout(() => {
        overlay.style.opacity = "1";
      }, 10);
      setTimeout(() => {
        overlay.style.opacity = "0";
        setTimeout(() => {
          overlay.style.display = "none";
        }, 1000);
      }, 4000);
    }

    function changeVersion(version) {
      if (version === "1.3") {
        window.location.href = window.location.href;
      } else if (version === "latest") {
        alert("ìµœì‹  ë²„ì „ìœ¼ë¡œ ì´ë™í•˜ë ¤ë©´ í•´ë‹¹ URLì„ ì…ë ¥í•˜ì„¸ìš”.");
      }
    }

    window.addEventListener("DOMContentLoaded", function() {
      document.getElementById("chat-input").addEventListener("keydown", function(e) {
        if (e.key === "Enter") sendChat();
      });
      
      const regionSelect = document.getElementById("region-select");
      regionList.forEach(region => {
        const option = document.createElement("option");
        option.value = region;
        option.textContent = `${region} (${regionMap[region]})`;
        if (region === currentCity) option.selected = true;
        regionSelect.appendChild(option);
      });
    });

    window.addEventListener("load", async () => {
      mainInit();       // Three.js ì´ˆê¸°í™” ë° ì”¬/ì˜¤ë¸Œì íŠ¸ êµ¬ì„±
      initCalendar();   // ë‹¬ë ¥ ì´ˆê¸°í™”
      showTutorial();   // íŠœí† ë¦¬ì–¼ ì˜¤ë²„ë ˆì´
      updateMap();      // ì§€ë„ ë¡œë“œ
      await updateWeatherAndEffects(); // ë‚ ì”¨ ë°˜ì˜
      onWindowResize(); // ìº”ë²„ìŠ¤ ì‚¬ì´ì¦ˆ ì¡°ì •
    });
  </script>
</body>
</html>
